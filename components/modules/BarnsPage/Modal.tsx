import { useStore } from 'effector-react'
import React, { useState } from 'react'
import { toast } from 'react-toastify'
import { AxiosError } from 'axios'

import { createBarnProductFx } from '@/app/api/barn'
import { $user } from '@/context/user'
import { IUser } from '@/types/user'
import { IProduct } from '@/types/products'
import { getLocalStorageUser } from '@/localStorageUser'
import { formatCarNumber } from '@/utils/car'
import { dateFormater } from '@/utils/dateFormater'
import AZ_FLAG_IMAGE from '@/components/elements/AZ_FLAG_IMAGE'

import styles from '@/styles/barn/form/add/index.module.scss'
import spinnerStyles from '@/styles/spinner/index.module.scss'

interface ModalProps {
  isOpen: boolean
  product: IProduct | null
  onClose: () => void
}

const BarnModal: React.FC<ModalProps> = ({ isOpen, onClose, product }) => {
  const [spinner, setSpinner] = useState<boolean>(false)

  const [openInfoProduct, setOpenInfoProduct] = useState(true)
  const [senderName, setSenderName] = useState<string>('')

  // car
  const [driverName, setDriverName] = useState<string>('')
  const [isAze, setIsAze] = useState<'yes' | 'no' | ''>('')
  const [isOpenAze, setIsOpenAze] = useState(true)
  const [carNumber, setCarNumber] = useState<string>('')

  // from product amd time
  const [fromLocation, setFromLocation] = useState<string>('')
  const [location, setLocation] = useState<string>('')
  const [userSelectedDate, setUserSelectedDate] = useState<string>('')

  // stocks
  const [newStock, setNewStock] = useState<string>('')
  const [usedStock, setUsedStock] = useState<string>('')
  const [brokenStock, setBrokenStock] = useState<string>('')
  const totalStock = +brokenStock + +usedStock + +newStock

  const validate: boolean =
    senderName.length < 3 ||
    driverName.length < 3 ||
    carNumber.length < 7 ||
    fromLocation.length < 3 ||
    location.length < 3 ||
    !userSelectedDate ||
    totalStock < 0 ||
    isNaN(totalStock)

  console.log('validate')
  console.log(validate)

  const user: IUser = useStore($user)
  const userId = +user?.id || getLocalStorageUser().userIdStorage
  const barnUsername: string =
    user?.username || getLocalStorageUser().usernameStorage

  const clearData = () => {
    setOpenInfoProduct(true)
    setSenderName('')
    setDriverName('')
    setIsAze('')
    setIsOpenAze(true)
    setCarNumber('')
    setFromLocation('')
    setLocation('')
    setUserSelectedDate('')
    setNewStock('')
    setUsedStock('')
    setBrokenStock('')
  }

  const createNewBarn = async () => {
    if (product && userId && !validate) {
      try {
        setSpinner(true)

        const newBarn = {
          userId: +userId,
          productId: product.id,
          senderName,
          driverName,
          carNumber,
          fromLocation,
          location,
          userSelectedDate: dateFormater(userSelectedDate),
          newStock: +newStock,
          usedStock: +usedStock,
          brokenStock: +brokenStock,
        }

        console.log('new barn')
        console.log(newBarn)

        const result = await createBarnProductFx(newBarn)

        if (result.error_message) {
          toast.error(result.error_message)
          return
        }

        toast.success(result.message)
      } catch (error) {
        toast.error((error as AxiosError).message)
        clearData()
      } finally {
        clearData()
        onClose()
        setSpinner(false)
      }
    } else {
      toast.warning('B√ºt√ºn m…ôlumatlarƒ± daxil edin !')
    }
  }

  const toggleIsAze: boolean = isAze === 'yes' || isAze === 'no'

  const showPic: React.JSX.Element | '' =
    isAze === 'yes' ? <AZ_FLAG_IMAGE /> : ''

  if (!isOpen) return null

  return (
    <div className={styles.modal}>
      <div
        className={styles.modalContent}
        style={{
          maxWidth: openInfoProduct ? 1000 : 600,
        }}
      >
        <h2 style={{ textAlign: 'center' }}>
          Anbarda material yaratmaq Formasi
        </h2>
        <div>
          <span
            className={styles.close}
            onClick={() => {
              onClose()
              clearData()
            }}
          >
            &times;
          </span>
        </div>

        <button
          style={{ width: 50, fontSize: 18, cursor: 'pointer' }}
          onClick={() => setOpenInfoProduct(!openInfoProduct)}
        >
          {openInfoProduct ? '‚ùå' : 'üëÅÔ∏è'}
        </button>

        <div className={styles.modal__content}>
          {/* –æ–± –∞–º–±–∞—Ä–µ */}
          {openInfoProduct && (
            <div className={styles.info}>
              <div>
                <p>
                  Anbardar:{' '}
                  <b>
                    {barnUsername}
                    <span>{` (ID: ${userId}) `}</span>
                  </b>
                </p>
              </div>

              <div>
                <p>
                  Material Ad: <b>{product?.name}</b>
                </p>
              </div>

              <div>
                <p>
                  √ñl√ß√º vahidi: <b>{product?.unit}</b>
                </p>
              </div>

              <div>
                <p>
                  Qiym…ôt: <b>{product?.price} manat</b>
                </p>
              </div>
            </div>
          )}

          {/* –≤–≤–µ—Å—Ç–∏ –¥–∞–Ω–Ω—ã–µ */}

          <div className={styles.values}>
            <div className={styles.li}>
              <div className={styles.label__container}>
                <label className={styles.label__text}>
                  Materialƒ± siz…ô g√∂nd…ôr…ôn ≈ü…ôxsin adƒ±
                </label>
                <span className={styles.icon}>
                  {senderName.length > 3 ? '‚úÖ' : 'üë®‚Äçüíº'}
                </span>
              </div>
              <input
                type="text"
                value={senderName}
                onChange={(e) => setSenderName(e.target.value)}
                placeholder="g√∂nd…ôr…ônin adƒ±nƒ± yazƒ±n..."
                className={styles.modal__input}
              />
            </div>

            <div className={styles.li}>
              <div className={styles.label__container}>
                <label className={styles.label__text}>S√ºr√ºc√º adƒ±</label>
                <span className={styles.icon}>
                  {driverName.length > 3 ? '‚úÖ' : 'üë®‚Äç‚úàÔ∏è'}
                </span>
              </div>
              <input
                type="text"
                value={driverName}
                onChange={(e) => setDriverName(e.target.value)}
                placeholder="S√ºr√ºc√º adƒ± yazƒ±n..."
                className={styles.modal__input}
              />
            </div>

            {/* –Ω–æ–º–µ—Ä –º–∞—à–∏–Ω—ã */}
            {isOpenAze && (
              <div className={styles.label__container}>
                {/* –í–æ–ø—Ä–æ—Å */}

                <div>
                  <div>
                    <label style={{ display: 'flex' }}>
                      {'Az…ôrbaycan avtomobil n√∂mr…ôsidir ? (12-AB-345) '}
                      <AZ_FLAG_IMAGE />
                    </label>
                  </div>
                  <div className={styles.buttons}>
                    <button
                      className={styles.button}
                      onClick={() => {
                        setIsAze('yes')
                        setIsOpenAze(false)
                      }}
                    >
                      B…ôli
                    </button>
                    <button
                      className={styles.button}
                      onClick={() => {
                        setIsAze('no')
                        setIsOpenAze(false)
                      }}
                    >
                      Xeyr
                    </button>
                  </div>
                </div>

                {/* –í–≤–æ–¥ –Ω–æ–º–µ—Ä–∞ –º–∞—à–∏–Ω—ã */}
              </div>
            )}

            {toggleIsAze && (
              <div className={styles.li}>
                <div className={styles.label__container}>
                  <label>
                    {`Ma≈üƒ±nƒ±n n√∂mr…ôsi `}
                    {carNumber.length > 7 ? '‚úÖ' : 'üöõ'}
                  </label>
                  {showPic}
                  <h4>{isAze === 'no' ? ' -(Ba≈üqa √∂lk…ô)' : ''}</h4>
                  <span
                    style={{ padding: '0px 5px', color: 'yellow' }}
                    className={styles.button}
                    onClick={() => {
                      setIsOpenAze(true)
                      setIsAze('')
                      setCarNumber('')
                    }}
                  >
                    &times;
                  </span>
                </div>
                <div>
                  <input
                    type="text"
                    value={carNumber}
                    onChange={(e) => {
                      setIsOpenAze(false)
                      const value = e.target.value
                      if (isAze === 'yes') {
                        setCarNumber(formatCarNumber(value))
                      } else if (isAze === 'no') {
                        setCarNumber(value)
                      }
                    }}
                    placeholder="Ma≈üƒ±nƒ±n n√∂mr…ôsini yazƒ±n..."
                    className={styles.modal__input}
                  />
                </div>
              </div>
            )}

            <div className={styles.li}>
              <div className={styles.label__container}>
                <label className={styles.label__text}>
                  Material hardan g…ôlir?
                </label>
                <span className={styles.icon}>
                  {fromLocation.length > 3 ? '‚úÖ' : 'üåç'}
                </span>
              </div>
              <input
                type="text"
                value={fromLocation}
                onChange={(e) => setFromLocation(e.target.value)}
                placeholder="√ºnvanƒ± yazƒ±n..."
                className={styles.modal__input}
              />
            </div>

            <div className={styles.li}>
              <div className={styles.label__container}>
                <label className={styles.label__text}>Material hardadƒ±r?</label>
                <span className={styles.icon}>
                  {location.length > 3 ? '‚úÖ' : 'üìå'}
                </span>
              </div>
              <input
                type="text"
                value={location}
                onChange={(e) => setLocation(e.target.value)}
                placeholder="√ºnvanƒ± yazƒ±n..."
                className={styles.modal__input}
              />
            </div>

            <div className={styles.li}>
              <div className={styles.label__container}>
                <label className={styles.label__text}>
                  Materialƒ± hansƒ± tarixd…ô v…ô saatda almƒ±sƒ±nƒ±z?
                </label>
                <span className={styles.icon}>
                  {userSelectedDate ? '‚úÖ' : 'üìÖ'}
                </span>
              </div>
              <input
                type="datetime-local"
                value={userSelectedDate}
                onChange={(e) => setUserSelectedDate(e.target.value)}
                className={styles.modal__input}
              />
            </div>

            <div className={styles.li}>
              <div className={styles.label__container}>
                <label className={styles.label__text}>
                  Yeni Materialƒ±n Miqdarƒ±
                </label>
                <span className={styles.icon}>üÜïüì¶</span>
              </div>
              <input
                type="text"
                value={newStock}
                onChange={(e) => setNewStock(e.target.value)}
                placeholder="Yeni materialƒ±n miqdarƒ±nƒ± yazƒ±n..."
                className={styles.modal__input}
              />
            </div>

            <div className={styles.li}>
              <div className={styles.label__container}>
                <label className={styles.label__text}>
                  ƒ∞≈ül…ônmi≈ü Materialƒ±n Miqdarƒ±
                </label>
                <span className={styles.icon}>üõ†Ô∏èüì¶</span>
              </div>
              <input
                type="text"
                value={usedStock}
                onChange={(e) => setUsedStock(e.target.value)}
                placeholder="ƒ∞≈ül…ônmi≈ü materialƒ±n miqdarƒ±nƒ± yazƒ±n..."
                className={styles.modal__input}
              />
            </div>

            <div className={styles.li}>
              <div className={styles.label__container}>
                <label className={styles.label__text}>
                  Yararsƒ±z Materialƒ±n Miqdarƒ±
                </label>
                <span className={styles.icon}>‚ùåüì¶</span>
              </div>
              <input
                type="text"
                value={brokenStock}
                onChange={(e) => setBrokenStock(e.target.value)}
                placeholder="Yararsƒ±z materialƒ±n miqdarƒ±nƒ± yazƒ±n..."
                className={styles.modal__input}
              />
            </div>

            <div className={styles.label__container}>
              <label className={styles.label__text}>
                {`√úmumi Materialƒ±n Miqdarƒ±: `}
                <b style={{ fontSize: 20 }}>
                  {Number.isNaN(totalStock)
                    ? 'miqdar r…ôq…ôm olmalƒ±dƒ±r'
                    : totalStock}
                </b>
              </label>
              <span className={styles.icon}>
                {totalStock > 0 ? '‚úÖ' : 'üì¶'}
              </span>
            </div>
          </div>
        </div>

        <div className={styles.modal__cont}>
          <div>
            <button
              className={styles.modal__btn}
              onClick={createNewBarn}
              disabled={validate}
            >
              {spinner ? (
                <div className={spinnerStyles.spinner} />
              ) : (
                'Anbarda material yaratmaq'
              )}
            </button>
          </div>
        </div>
      </div>
    </div>
  )
}

export default BarnModal
